{"version":3,"sources":["appointment-tests.js"],"names":["test","require","sinon","proxyquire","Sequelize","Op","appointmentFixtures","config","logging","UserStub","AppointmentStub","db","sandbox","customer","Object","assign","user","doctor","docuser","oneAppointment","oneapp","changeAppointment","upapp","canceledAppointment","allapp","appointmentid","id","userid","ccid","ccidchange","vArgs","where","day","hourinit","hourend","userId","ccidArgs","ccidArgsCustomer","type","ccidArgsCustomerOrAdmin","newAppointment","doctorname","branch","state","assignedid","assignedname","createdAt","Date","updatedAt","dayinit","dayend","daysArgs","gte","lte","beforeEach","createSandbox","hasMany","spy","belongsTo","create","stub","withArgs","returns","Promise","resolve","toJSON","update","findById","byId","findOne","byrel","byCCid","byCCidCustomer","byCCidCustomerOrAdmin","findAll","bydays","setupDatabase","afterEach","restore","t","truthy","Appointment","User","serial","true","called","calledWith","appointment","createOrUpdate","calledOnce","deepEqual","appointments","findNoAssignedByDate","is","length","assignedAndUpdate","calledTwice"],"mappings":"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","file":"appointment-tests.js","sourcesContent":["'use strict'\n\nconst test = require('ava')\nconst sinon = require('sinon')\nconst proxyquire = require('proxyquire')\nconst Sequelize = require('sequelize')\nconst Op = Sequelize.Op\n\nconst appointmentFixtures = require('./fixtures/appointment')\n\nlet config = {\n  logging() {}\n}\n\nlet UserStub = null\nlet AppointmentStub = null\nlet db = null\nlet sandbox = null\n\nlet customer = Object.assign({}, appointmentFixtures.user)\nlet doctor = Object.assign({}, appointmentFixtures.docuser)\nlet oneAppointment = Object.assign({}, appointmentFixtures.oneapp)\nlet changeAppointment = Object.assign({}, appointmentFixtures.upapp)\nlet canceledAppointment = Object.assign({}, appointmentFixtures.allapp[1])\n\nlet appointmentid = oneAppointment.id\nlet userid = doctor.id\nlet ccid = doctor.ccid\n\nlet ccidchange = customer.ccid\n\nlet vArgs = {\n  where:{\n    day:oneAppointment.day,\n    hourinit:oneAppointment.hourinit,\n    hourend:oneAppointment.hourend,\n    userId:oneAppointment.userId\n  }\n}\n\nlet ccidArgs = {\n  where: { ccid }\n}\n\nlet ccidArgsCustomer = {\n  where: {\n    ccid:ccidchange,\n    type:'customer'\n  }\n}\n\nlet ccidArgsCustomerOrAdmin = {\n  where: {\n    ccid:ccidchange,\n    type:'customer'\n  }\n}\n\nlet newAppointment = {\n  id:5,\n  userId:2,\n  day: '2018-06-28',\n  hourinit: '8:00',\n  hourend:  '9:00',\n  doctorname: 'Pepito PÃ©rez',\n  type: 'General',\n  branch:1,\n  state:1,\n  assignedid:0,\n  assignedname:'',\n  createdAt: new Date(),\n  updatedAt: new Date()\n  // operatorsAliases: false\n}\n\nlet dayinit = '2018-06-20'\nlet dayend = '2018-06-24'\n\n// UserStub = {\n//  hasMany: sinon.spy()\n// }\nlet daysArgs = {\n  where: {\n    day:{\n      [Op.gte]: dayinit,\n      [Op.lte]: dayend\n    },\n    state:1\n  }\n}\n\n// let changeAppointment = appointmentFixtures.extend(oneAppointment,assign)\n\ntest.beforeEach(async () => {\n  sandbox = sinon.createSandbox()\n\n  UserStub = {\n    hasMany: sandbox.spy()\n  }\n\n  AppointmentStub = {\n    belongsTo: sandbox.spy()\n  }\n\n  // Model create and update Stub\n  AppointmentStub.create = sandbox.stub()\n  AppointmentStub.create.withArgs(newAppointment).returns(Promise.resolve({\n    toJSON() { return newAppointment }\n  }))\n\n  AppointmentStub.update = sandbox.stub()\n  AppointmentStub.update.withArgs(oneAppointment).returns(Promise.resolve(oneAppointment))\n  AppointmentStub.update.withArgs(changeAppointment).returns(Promise.resolve(changeAppointment))\n\n  AppointmentStub.findById = sandbox.stub()\n  AppointmentStub.findById.withArgs(oneAppointment.id).returns(Promise.resolve(appointmentFixtures.byId(oneAppointment.id)))\n  AppointmentStub.findById.withArgs(changeAppointment.id).returns(Promise.resolve(appointmentFixtures.byId(changeAppointment.id)))\n  // Model findOne Stub (with ccid)\n\n  AppointmentStub.findOne = sandbox.stub()\n  AppointmentStub.findOne.withArgs(vArgs).returns(Promise.resolve(appointmentFixtures.byrel(appointmentid, userid)))\n\n  // Model findOne Stub (with ccid)\n\n  UserStub.findOne = sandbox.stub()\n  UserStub.findOne.withArgs(ccidArgs).returns(Promise.resolve(appointmentFixtures.byCCid(ccid)))\n  UserStub.findOne.withArgs(ccidArgsCustomer).returns(Promise.resolve(appointmentFixtures.byCCidCustomer(ccidchange)))\n  UserStub.findOne.withArgs(ccidArgsCustomerOrAdmin).returns(Promise.resolve(appointmentFixtures.byCCidCustomerOrAdmin(ccidchange)))\n\n\n  AppointmentStub.findAll = sandbox.stub()\n  AppointmentStub.findAll.withArgs(daysArgs).returns(Promise.resolve(appointmentFixtures.bydays(dayinit, dayend)))\n\n  // Model findById Stub\n  // UserStub.findById = sandbox.stub()\n  // UserStub.findById.withArgs(id).returns(Promise.resolve(userFixtures.byId(id))) */\n\n  const setupDatabase = proxyquire('../', {\n    './models/user': () => UserStub,\n    './models/appointment': () => AppointmentStub\n  })\n\n  db = await setupDatabase(config)\n})\n\ntest.afterEach(() => {\n  sandbox && sandbox.restore()\n})\n\ntest('Appointment', t => {\n  t.truthy(db.Appointment, 'Appointment service should exist')\n})\n\ntest('User', t => {\n  t.truthy(db.User, 'User service should exist')\n})\n\ntest.serial('Setup', t => {\n  t.true(UserStub.hasMany.called, 'UserModel.hasMany was executed')\n  t.true(UserStub.hasMany.calledWith(AppointmentStub), 'Argument should be the AppointmentModel')\n  t.true(AppointmentStub.belongsTo.called, 'AppointmentModel.belongsTo was executed')\n  t.true(AppointmentStub.belongsTo.calledWith(UserStub), 'Argument should be the UserModel')\n})\n\ntest.serial('Appointmet#createOrUpdate - new - user - doctor', async t => {\n  let appointment = await db.Appointment.createOrUpdate(ccid, newAppointment)\n\n  // Primero buscamos el usuario\n  t.true(UserStub.findOne.called, 'findOne (user) should be called on model')\n  t.true(UserStub.findOne.calledOnce, 'findOne (user) should be called twice')\n  t.true(UserStub.findOne.calledWith(ccidArgs), 'findOne (user) should be called with ccid args')\n\n  // Luego buscamos la cita\n  t.true(AppointmentStub.findOne.called, 'findOne (appoint) should be called on model')\n  t.true(AppointmentStub.findOne.calledOnce, 'findOne (appoint) should be called once')\n  t.true(AppointmentStub.findOne.calledWith({\n    where:{\n      id:newAppointment.id,\n      userId:newAppointment.userId\n    }\n  }), 'findOne (appoint) should be called with vargs')\n\n  // Luego creamos la cita\n  t.true(AppointmentStub.create.called, 'appointment.create called on model')\n  t.true(AppointmentStub.create.calledOnce, 'appointment.create should be called once')\n  t.true(AppointmentStub.create.calledWith(newAppointment), 'appointment.create should be called with specified args')\n  t.deepEqual(appointment, newAppointment, 'appointment should be the same')\n})\n\ntest.serial('Appointmet#createOrUpdate - exist - user - doctor', async t => {\n  let appointment = await db.Appointment.createOrUpdate(ccid, oneAppointment)\n\n  // Primero buscamos el usuario\n  t.true(UserStub.findOne.called, 'findOne (user) should be called on model')\n  t.true(UserStub.findOne.calledOnce, 'findOne (user) should be called twice')\n  t.true(UserStub.findOne.calledWith(ccidArgs), 'findOne (user) should be called with ccid args')\n\n  // Luego buscamos la cita (que ya existe)\n  t.true(AppointmentStub.findOne.called, 'findOne (appoint) should be called on model')\n  t.true(AppointmentStub.findOne.calledOnce, 'findOne (appoint) should be called twice')\n  t.true(AppointmentStub.findOne.calledWith(vArgs), 'findOne (appoint) should be called with vargs')\n\n  // Volvemos a buscarlas por el id\n  t.true(AppointmentStub.findById.called, 'findById (appoint) should be called on model')\n  t.true(AppointmentStub.findById.calledOnce, 'findById (appoint) should be called twice')\n  t.true(AppointmentStub.findById.calledWith(oneAppointment.id), 'findById (appoint) should be called with vargs')\n\n  // Al encontrarla, la actualizamos\n  t.true(AppointmentStub.update.called, 'appointment.update called on model')\n  t.true(AppointmentStub.update.calledOnce, 'appointment.update should be called once')\n  t.true(AppointmentStub.update.calledWith(oneAppointment), 'appointment.update should be called with specified args')\n\n  t.deepEqual(appointment, oneAppointment, 'appointment should be the same')\n})\n\ntest.serial('Appointment#findNoAssignedByDate', async t => {\n  let appointments = await db.Appointment.findNoAssignedByDate(dayinit, dayend)\n\n  // Buscamos con un alll\n  t.true(AppointmentStub.findAll.called, 'findOne should be called on model')\n  t.true(AppointmentStub.findAll.calledOnce, 'findOne should be called twice')\n  t.true(AppointmentStub.findAll.calledWith(daysArgs), 'findOne should be called with ccid args')\n\n  t.is(appointments.length, appointmentFixtures.bydays(dayinit, dayend).length, 'agents should be the same amount')\n  t.deepEqual(appointments, appointmentFixtures.bydays(dayinit, dayend), 'agents should be the same')\n})\n\ntest.serial('Appointment#AssignedAndUpdate - exist - user - customer', async t => {\n  let appointment = await db.Appointment.assignedAndUpdate(ccidchange, canceledAppointment.id)\n\n  // Primero buscamos el usuario\n  t.true(UserStub.findOne.called, 'findOne (user) should be called on model')\n  t.true(UserStub.findOne.calledOnce, 'findOne (user) should be called twice')\n  t.true(UserStub.findOne.calledWith(ccidArgsCustomerOrAdmin), 'findOne (user) should be called with ccid args')\n\n  // Volvemos a buscarlas por el id\n  t.true(AppointmentStub.findById.called, 'findById (appoint) should be called on model')\n  t.true(AppointmentStub.findById.calledTwice, 'findById (appoint) should be called twice')\n  t.true(AppointmentStub.findById.calledWith(changeAppointment.id), 'findById (appoint) should be called with vargs')\n\n  // console.log('El total de los usuario es: ' +  JSON.stringify(appointmentFixtures.extend(oneAppointment,\n  //  assign)) + '\\n\\n')\n\n  // Al encontrarla, la actualizamos\n  t.true(AppointmentStub.update.called, 'appointment.update called on model')\n  t.true(AppointmentStub.update.calledOnce, 'appointment.update should be called once')\n  t.true(AppointmentStub.update.calledWith(changeAppointment), 'appointment.update should be called with specified args')\n\n  t.deepEqual(appointment, changeAppointment, 'appointment should be the same')\n})\n\ntest.serial('Appointmet#CanceledAndUpdate - exist - user/admin - customer', async t => {\n  let appointment = await db.Appointment.assignedAndUpdate(ccidchange, canceledAppointment.id)\n\n  // Primero buscamos el usuario\n  t.true(UserStub.findOne.called, 'findOne (user) should be called on model')\n  t.true(UserStub.findOne.calledOnce, 'findOne (user) should be called twice')\n  t.true(UserStub.findOne.calledWith(ccidArgsCustomerOrAdmin), 'findOne (user) should be called with ccid args')\n\n  // Volvemos a buscarlas por el id\n  t.true(AppointmentStub.findById.called, 'findById (appoint) should be called on model')\n  t.true(AppointmentStub.findById.calledTwice, 'findById (appoint) should be called twice')\n  t.true(AppointmentStub.findById.calledWith(canceledAppointment.id), 'findById (appoint) should be called with vargs')\n\n  // console.log('El total de los usuario es: ' +  JSON.stringify(appointmentFixtures.extend(oneAppointment,\n  //  assign)) + '\\n\\n')\n\n  // Al encontrarla, la actualizamos\n  t.true(AppointmentStub.update.called, 'appointment.update called on model')\n  t.true(AppointmentStub.update.calledOnce, 'appointment.update should be called once')\n  t.true(AppointmentStub.update.calledWith(canceledAppointment), 'appointment.update should be called with specified args')\n\n  t.deepEqual(appointment, canceledAppointment, 'appointment should be the same')\n})\n"]}